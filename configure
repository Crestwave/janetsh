#!/bin/sh

set -eu

fail() {
  echo "$0: $*" >&2
  exit 1
}

usage () {
  cat <<EOF
./configure CC=... CFLAGS=... LDFLAGS=... --prefix=... --janet-header-cflags=...
EOF
  exit 1
}

JANET_HEADER_CFLAGS=""
prefix="/usr"
CC="${CC:-cc}"
CFLAGS="${CFLAGS:--Wall -O2}"
LDFLAGS="${LDFLAGS:-}"

for arg ; do
  case "$arg" in
  --prefix=*) prefix=${arg#*=} ;;  
  --janet-header-cflags=*) JANET_HEADER_CFLAGS=${arg#*=} ;;
  CC=*) CC=${arg#*=} ;;
  CFLAGS=*) CFLAGS=${arg#*=} ;;
  LDFLAGS=*) LDFLAGS=${arg#*=} ;;
  --help) usage ;;
  *) fail "unknown option '$arg'"
  esac
done

check_janet_headers () {
  tempdir="$(mktemp -d)"
  cfile="$tempdir/test.c"
  cat <<EOF > "$cfile"
  #include <janet.h>
  int main() { return 0; }
EOF
  TEST="$CC $JANET_HEADER_CFLAGS -c $cfile -o $tempdir/test.out"
  echo "checking headers with \"$TEST\""
  $TEST > /dev/null 2>&1
  rc="$?"
  echo "test exited with: $rc"
  rm -r "$tempdir"
  return "$rc"
}

echo "Testing janet headers..."
if ! check_janet_headers
then
  echo "janet headers did not work, trying pkg-config..."
  JANET_HEADER_CFLAGS=$(pkg-config --cflags janet)
  if ! check_janet_headers
  then
    fail "unable to find working janet headers."
  fi
fi

CFLAGS="${CFLAGS} ${JANET_HEADER_CFLAGS}"

echo "writing config.inc"
cat >config.inc <<EOF
PREFIX="${prefix}"
CC="${CC}"
CFLAGS="${CFLAGS}"
LDFLAGS="${LDFLAGS}"
JANET_HEADER_CFLAGS="${JANET_HEADER_CFLAGS}"
EOF


echo "configured with:"
cat config.inc

